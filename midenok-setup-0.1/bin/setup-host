#!/bin/bash
host=$1
pub_key=$2

read -r -d '' remote_code <<EOF
mkdir -p .ssh
cd .ssh
tar xz
if [ -n "$pub_key" ]
then
    cat $pub_key  >> authorized_keys
    chmod g=,o= . authorized_keys $pub_key
fi
[ -d ~/.mc ] || mkdir -p ~/.mc

for f in ini panels.ini
do
    setup/helpers/gen-sed < setup/share/mc/\$f > ~/.mc/\$f.sed

    if [ -f ~/.mc/\$f ]
    then
        sed -f "\$HOME/.mc/\$f.sed" -i "\$HOME/.mc/\$f"
    else
        f_in="setup/share/mc/\$f"
        cp -a "\$f_in" ~/.mc/
        if [ "\$f" = panels.ini ]
        then
            sed -e "s/New Left/New Right/" "\$f_in" >> ~/.mc/\$f
        fi
    fi
done

cp -u setup/share/gdb/.gdbinit "\$HOME"
bash -l
EOF

# tar:
# ~/.gdbinit
tar cz $pub_key setup/helpers setup/share setup/bin | ssh -o StrictHostKeyChecking=no "$host" "$remote_code"
